<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CIT Score Leaderboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<style>
.team-tab{cursor:pointer}
.small-muted{font-size:.85rem;color:#6c757d}
.bar-label{font-weight:600}
.progress-bar{transition:width .7s ease;}
.last-editor{font-size:0.8rem;margin-top:2px;}
.last-editor.recent{color:#198754;font-weight:600;}
.last-editor.old{color:#6c757d;}
</style>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-1">
    <h3 class="m-0">UNIT LEADERBOARD</h3>
    <div>
      <button id="btnUnlock" class="btn btn-outline-primary btn-sm">Enter Passcode (Editor)</button>
      <button id="btnLogout" class="btn btn-outline-secondary btn-sm d-none">Logout Editor</button>
      <span id="syncStatus" class="badge bg-secondary ms-2">sync: unknown</span>
    </div>
  </div>
  <div class="small-muted mb-3" id="lastUpdated">Last updated: never</div>

  <div class="row mb-3">
    <div class="col-lg-8 mb-3">
      <div class="card p-3">
        <h5>Leaderboard</h5>
        <div id="leaderboardBars" class="mt-3"></div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card p-3">
        <h6 class="mb-2">Teams</h6>
        <div class="list-group" id="teamList"></div>
      </div>
    </div>
  </div>

  <div id="teamArea" class="card p-3 mb-4 d-none">
    <div class="d-flex justify-content-between">
      <h5 id="teamTitle"></h5>
      <div class="small-muted">Total: <span id="teamTotal" class="fw-bold">0</span></div>
    </div><hr>

    <form id="addRecordForm" class="row g-2 mb-3">
      <div class="col-md-3">
        <select id="recordCategory" class="form-select" required>
          <option value="event">Event Score</option>
          <option value="merit">Merit</option>
          <option value="demerit">Demerit</option>
        </select>
      </div>
      <div class="col-md-5"><input id="recordDesc" class="form-control" placeholder="Description" required></div>
      <div class="col-md-2"><input id="recordPoints" type="number" class="form-control" placeholder="Points" required></div>
      <div class="col-md-2 d-grid"><button class="btn btn-success" type="submit">âž• Add</button></div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light"><tr><th width="160">Timestamp</th><th>Category</th><th>Description</th><th width="90">Points</th><th width="140">Action</th></tr></thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card p-3">
    <h6>Audit Log (Backup in Google Sheet)</h6>
    <div class="table-responsive" style="max-height:360px;overflow:auto;">
      <table class="table table-sm">
        <thead class="table-dark sticky-top text-white">
          <tr><th>Timestamp</th><th>Team</th><th>Category</th><th>Description</th><th>Points</th><th>Editor</th></tr>
        </thead>
        <tbody id="auditBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Passcode Modal -->
<div class="modal fade" id="passcodeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <form id="passForm" class="p-3">
        <div class="modal-header"><h5 class="modal-title">Enter Editor Passcode</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><input id="passInput" type="password" class="form-control" placeholder="Passcode"><div id="passMsg" class="small-muted mt-2"></div></div>
        <div class="modal-footer"><button type="submit" class="btn btn-primary">Unlock</button></div>
      </form>
    </div>
  </div>
</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbxO2B5SOWfN5NPmpJMYpWzo1msJ-SxoTEH7Wwpf-3_eynqgPeGhSjCXNgmWlzc-ceU/exec';
const TEAMS=['Spades','Clubs','Hearts','Diamonds'];
const KEY_UI_DATA='cit_ui_data',KEY_IS_EDITOR='cit_isEditor',KEY_EDITOR_NAME='cit_editorName';
let currentTeam=TEAMS[0],uiData={},isEditor=localStorage.getItem(KEY_IS_EDITOR)==='true';

const teamList=document.getElementById('teamList'),
      leaderboardBars=document.getElementById('leaderboardBars'),
      recordsBody=document.getElementById('recordsBody'),
      teamArea=document.getElementById('teamArea'),
      teamTitle=document.getElementById('teamTitle'),
      teamTotalEl=document.getElementById('teamTotal'),
      auditBody=document.getElementById('auditBody'),
      btnUnlock=document.getElementById('btnUnlock'),
      btnLogout=document.getElementById('btnLogout'),
      passModal=new bootstrap.Modal(document.getElementById('passcodeModal')),
      passForm=document.getElementById('passForm'),
      passInput=document.getElementById('passInput'),
      passMsg=document.getElementById('passMsg'),
      syncStatus=document.getElementById('syncStatus'),
      lastUpdatedEl=document.getElementById('lastUpdated');

function setSyncStatus(t,c='secondary'){
  syncStatus.textContent='sync: '+t;
  syncStatus.className='badge bg-'+c+' ms-2';
  lastUpdatedEl.textContent='Last updated: '+new Date().toLocaleTimeString();
}

// ---------------- Load Data ----------------
async function loadData(){
  setSyncStatus('loading','warning');
  try {
    const res = await fetch(`${API_URL}?action=getData&_=${Date.now()}`);
    if(!res.ok) throw new Error('Network response not OK');
    const json = await res.json();
    if(json.ok){
      uiData = json.data || {};
      localStorage.setItem(KEY_UI_DATA, JSON.stringify(uiData));
      setSyncStatus('synced','success');
    } else {
      console.error('Server returned error', json);
      setSyncStatus('data-error','danger');
    }
  } catch(err){
    console.error('Load failed', err);
    setSyncStatus('offline','danger');
  } finally {
    renderAll();
  }
}

// ---------------- Save Data (JSONP) ----------------
async function saveData() {
  const now = new Date().toISOString();
  const name = localStorage.getItem(KEY_EDITOR_NAME) || 'Unknown';
  uiData._lastEdit = { name, time: now };
  localStorage.setItem(KEY_UI_DATA, JSON.stringify(uiData));
  setSyncStatus('saving', 'info');

  try {
    const payload = encodeURIComponent(JSON.stringify(uiData));
    const callbackName = 'jsonpSaveCallback_' + Date.now();

    const result = await new Promise((resolve, reject) => {
      window[callbackName] = (res) => {
        delete window[callbackName];
        resolve(res);
      };

      const script = document.createElement('script');
      script.src = `${API_URL}?action=saveData&data=${payload}&editor=${encodeURIComponent(name)}&callback=${callbackName}&_=${Date.now()}`;
      script.onerror = () => {
        delete window[callbackName];
        reject(new Error('JSONP request failed'));
      };
      document.body.appendChild(script);
    });

    if (result.ok) {
      setSyncStatus('saved', 'success');
      await loadData();
    } else {
      console.error('Save failed', result);
      setSyncStatus('save-failed', 'danger');
    }

  } catch (err) {
    console.error('Save failed', err);
    setSyncStatus('save-error', 'danger');
  }
}

// ---------------- Rendering ----------------
function minutesAgo(t){ if(!t)return Infinity; return (Date.now()-new Date(t).getTime())/60000; }

function renderLeaderboard(){
  leaderboardBars.innerHTML='';
  const totals={};
  TEAMS.forEach(t=>totals[t]=(uiData[t]||[]).reduce((s,r)=>s+(r.category==='demerit'?-r.points:+r.points||0),0));
  const max=Math.max(...Object.values(totals).map(v=>Math.abs(v)),1);
  TEAMS.forEach(t=>{
    const v=totals[t]||0;
    const pct=Math.round(Math.abs(v)/max*100);
    const color=v>=0?'success':'danger';
    const div=document.createElement('div');
    div.className='mb-2';
    div.innerHTML=`
      <div class="d-flex justify-content-between"><div class="bar-label">${t}</div><div class="fw-bold">${v}</div></div>
      <div class="progress" style="height:18px;"><div class="progress-bar bg-${color}" style="width:${pct}%">${pct}%</div></div>`;
    const le=document.createElement('div');
    le.className='last-editor';
    if(uiData._lastEdit){
      const mins=minutesAgo(uiData._lastEdit.time);
      le.classList.add(mins<=10?'recent':'old');
      le.textContent=`Last edited by ${uiData._lastEdit.name} at ${new Date(uiData._lastEdit.time).toLocaleString()}`;
    } else le.textContent='No edits yet';
    div.appendChild(le);
    leaderboardBars.appendChild(div);
  });
}

function renderTeamList(){
  teamList.innerHTML='';
  TEAMS.forEach(t=>{
    const b=document.createElement('button');
    b.className='list-group-item list-group-item-action team-tab'+(t===currentTeam?' active':'');
    b.textContent=t;
    b.onclick=()=>{currentTeam=t;renderAll();};
    teamList.appendChild(b);
  });
}

function renderTeamArea(){
  teamArea.classList.remove('d-none');
  teamTitle.textContent=currentTeam;
  const logs=uiData[currentTeam]||[];
  teamTotalEl.textContent=logs.reduce((a,b)=>a+(b.category==='demerit'?-b.points:+b.points),0);
  recordsBody.innerHTML='';
  logs.slice().reverse().forEach((l,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${l.timestamp}</td><td>${l.category}</td><td>${l.description}</td><td class="text-end">${l.points}</td><td>${isEditor?`<button class="btn btn-sm btn-outline-danger" data-i="${i}">Delete</button>`:''}</td>`;
    recordsBody.appendChild(tr);
  });
  if(isEditor){
    recordsBody.querySelectorAll('button').forEach(b=>b.onclick=()=>{
      const idx=b.dataset.i;
      if(confirm('Delete this record?')){
        uiData[currentTeam].splice(logs.length-1-idx,1);
        saveData();renderAll();
      }
    });
  }
}

function renderAudit(){
  auditBody.innerHTML='';
  TEAMS.forEach(t=>(uiData[t]||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.timestamp}</td><td>${t}</td><td>${r.category}</td><td>${r.description}</td><td class="text-end">${r.points}</td><td>${r.editor||''}</td>`;
    auditBody.appendChild(tr);
  }));
}

function renderAll(){renderTeamList();renderLeaderboard();renderTeamArea();renderAudit();}

// ---------------- Event Listeners ----------------
document.getElementById('addRecordForm').addEventListener('submit',e=>{
  e.preventDefault();
  if(!isEditor)return alert('Enter passcode to edit.');
  const c=recordCategory.value,d=recordDesc.value.trim(),p=+recordPoints.value;
  if(!d||isNaN(p))return alert('Fill all fields.');
  const entry={category:c,description:d,points:p,timestamp:new Date().toLocaleString(),editor:localStorage.getItem(KEY_EDITOR_NAME)||'Editor'};
  if(!uiData[currentTeam])uiData[currentTeam]=[];
  uiData[currentTeam].push(entry);
  saveData();renderAll();e.target.reset();
});

btnUnlock.onclick=()=>{passInput.value='';passMsg.textContent='';passModal.show();};
btnLogout.onclick=()=>{isEditor=false;localStorage.removeItem(KEY_IS_EDITOR);updateEditorUI();};

passForm.onsubmit=async e=>{
  e.preventDefault();
  const pass=passInput.value.trim();
  if(!pass)return passMsg.textContent='Enter passcode';
  try{
    const r=await fetch(API_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({action:'checkPass',pass})});
    const j=await r.json();
    if(j&&j.ok){
      let n=localStorage.getItem(KEY_EDITOR_NAME)||prompt('Editor name:','');
      if(n)localStorage.setItem(KEY_EDITOR_NAME,n);
      isEditor=true;localStorage.setItem(KEY_IS_EDITOR,'true');
      passModal.hide();updateEditorUI();
    }else passMsg.textContent='Incorrect passcode.';
  }catch(err){passMsg.textContent='Connection failed: '+err.message;}
};

function updateEditorUI(){
  const f=addRecordForm;
  if(isEditor){
    btnUnlock.classList.add('d-none');btnLogout.classList.remove('d-none');
    f.querySelectorAll('input,select,button').forEach(e=>e.disabled=false);
  } else {
    btnUnlock.classList.remove('d-none');btnLogout.classList.add('d-none');
    f.querySelectorAll('input,select,button').forEach(e=>e.disabled=true);
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  updateEditorUI();
  loadData();
  if(!isEditor)setInterval(loadData,30000);
});
</script>

</body>
</html>


